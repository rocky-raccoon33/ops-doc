## 1.简介 

---
### 1.1 基本概念
- 原子性
>两阶段提交协议保证事务的原子性
- 一致性  
>事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的
- 隔离性  
>在MySQL模式下，支持 Read Committed 隔离级别和 Repeatable Read 隔离 级别。
- 持久化  
>redo log记录数据修改,WAL机制保证宕机恢复，paxos保证多副本数据同步

---
### 1.2 执行流程
- 创建全局事务ID
- 识别分区数据
- 创建分区对应的上下文(记录修改)
- 等待commit/rollback
- 持久化到clog
- ddl发起隐式commit,断开连接发起隐式rollback

### 1.3 全局时间戳
- 对于用户租户而言，租户级别内部表 __all_dummy 的 leader 作为 GTS 服务提供者，时间来源于该leader的本地时钟。GTS 默认是三副本的，其高可用能力跟普通表的能力一样。
- 对于系统租户，使用 __all_core_table 的 leader 作为 GTS 服务的提供者，高可用能力与普通表一样
- 时间戳正确性保证
   - 有主改选 
     - 原 Leader 主动发起改选的场景，我们称为有主改选。新 leader 上任之前先获取旧 leader 的最大已经授 权的时间戳作为新 leader 时间戳授权的基准值。因此该场景下，GTS 提供的时间戳不会回退。
   - 无主选举
     - 原 leader 与多数派成员发生网络隔离，等 lease 过期之后，原 follower 会重新选主，这一个过程，我们 称为无主选举。选举服务保证了无主选举场景下，新旧 Leader 的 lease 是不重叠的，因此能够保证本地 时钟一定大于旧主提供的最大时间戳。因此新 leader 能够保证 GTS 提供的时间戳不回退。

### 1.4 事务控制
- 事务配置
  - 大小
    - 2.x版本上限为100M，3.x不做限制
    - 租户级配置项(优先) _tenant_max_trx_size 、集群级配置项 _max_trx_size
  - 状态
    - 虚拟表 __all_virtual_trans_stat 里的 state 字段标识了事务所处的状态
  - 超时
    - 语句超时时间,系统变量ob_query_timeout,默认为10s
    - 事务超时时间,系统变量ob_trx_timeout,事务超时时需应用主动发起rollback
    - 事务超时自动回滚时间,系统变量 ob_trx_idle_timeout,即session上一个事务处于的 IDLE(空闲) 状态的最长时间
  - Savepoint
    - 事务执行中的保存点，可回滚至保存点 